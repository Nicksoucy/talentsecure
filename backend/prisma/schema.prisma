// This is your Prisma schema file
// Documentation: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  ADMIN
  RH_RECRUITER
  SALES
}

enum CandidateStatus {
  QUALIFIE // 7-7.9
  BON // 8-8.4
  TRES_BON // 8.5-8.9
  EXCELLENT // 9-9.4
  ELITE // 9.5+
  A_REVOIR // < 7
  EN_ATTENTE // En cours d'évaluation
  INACTIF // Plus disponible
  ABSENT // Absent à l'entretien
}

enum AvailabilityType {
  JOUR
  SOIR
  NUIT
  FIN_DE_SEMAINE
}

enum LanguageLevel {
  DEBUTANT
  INTERMEDIAIRE
  AVANCE
  BILINGUE
  LANGUE_MATERNELLE
}

enum CatalogueStatus {
  BROUILLON
  GENERE
  ENVOYE
  ACCEPTE
  REFUSE
}

enum PlacementStatus {
  EN_NEGOCIATION
  CONFIRME
  EN_COURS
  TERMINE
  ANNULE
}

enum AuditAction {
  CREATE
  READ
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
}

enum CatalogueSelectionStatus {
  INTERESSE // Client a cliqué "Intéressé"
  DEMANDE // Client a fait une demande formelle
  ACCEPTE // Demande acceptée par admin
  PLACE // Candidat placé chez le client
  REFUSE // Demande refusée
  ANNULE // Demande annulée
}

enum PaymentStatus {
  PENDING // En attente de paiement
  PAID // Payé
  FAILED // Échec de paiement
  REFUNDED // Remboursé
  CANCELLED // Annulé
}

enum CandidateType {
  EVALUATED // Candidat évalué (premium)
  CV_ONLY // CV seulement (économique)
}

enum WishlistStatus {
  DRAFT // Client en train de construire
  SUBMITTED // Demande envoyée à l'admin
  APPROVED // Admin a approuvé
  PAID // Client a payé
  DELIVERED // Catalogue livré
  CANCELLED // Annulé
}

enum SkillCategory {
  TECHNICAL // Compétences techniques (ex: Informatique, Mécanique)
  SOFT_SKILL // Compétences comportementales (ex: Leadership, Communication)
  CERTIFICATION // Certifications et permis (ex: BSP, Premiers soins)
  LANGUAGE // Langues (déjà géré par Language model, mais peut être utile)
  INDUSTRY // Domaine d'industrie (ex: Sécurité, Construction, Automobile)
  TOOL_EQUIPMENT // Outils et équipements (ex: Chariot élévateur, Systèmes de sécurité)
  OTHER // Autres compétences
}

enum SkillLevel {
  BEGINNER // Débutant (0-1 an d'expérience)
  INTERMEDIATE // Intermédiaire (1-3 ans)
  ADVANCED // Avancé (3-5 ans)
  EXPERT // Expert (5+ ans)
  UNKNOWN // Non spécifié
}

enum SkillSource {
  REGEX_EXTRACTED // Extrait par regex automatique
  AI_EXTRACTED // Extrait par IA (OpenAI/Claude)
  MANUAL_ENTRY // Ajouté manuellement par admin
  HUMAN_VERIFIED // Vérifié/corrigé par humain
}

// Models

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String? // Null si OAuth uniquement
  firstName String
  lastName  String
  role      UserRole @default(RH_RECRUITER)

  // OAuth
  googleId    String? @unique
  microsoftId String? @unique

  // Metadata
  isActive    Boolean   @default(true)
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  candidatesCreated   Candidate[]          @relation("CandidateCreatedBy")
  cataloguesCreated   Catalogue[]          @relation("CatalogueCreatedBy")
  placementsCreated   Placement[]          @relation("PlacementCreatedBy")
  selectionsResponded CatalogueSelection[] @relation("SelectionResponder")
  paymentsProcessed   CataloguePayment[]   @relation("PaymentProcessor")
  auditLogs           AuditLog[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model Candidate {
  id String @id @default(uuid())

  // Informations personnelles
  firstName  String
  lastName   String
  email      String?
  phone      String
  address    String?
  city       String
  province   String  @default("QC")
  postalCode String?

  // Statut et évaluation
  status        CandidateStatus @default(EN_ATTENTE)
  globalRating  Float? // Note globale /10
  interviewDate DateTime? // Date de l'entrevue RH

  // Évaluation détaillée
  professionalismRating Float? // /10
  communicationRating   Float? // /10
  appearanceRating      Float? // /10
  motivationRating      Float? // /10
  experienceRating      Float? // /10

  // Commentaires RH
  hrNotes    String? @db.Text
  strengths  String? @db.Text
  weaknesses String? @db.Text

  // Détails complets d'entretien (JSON)
  interviewDetails Json? // Stocke toutes les infos de l'onglet candidat

  // Disponibilités
  hasVehicle  Boolean @default(false)
  canTravelKm Int? // Rayon de déplacement en km

  // Permis et certifications
  hasBSP        Boolean   @default(false)
  bspNumber     String?
  bspExpiryDate DateTime?
  bspStatus     String? // "Actif", "En cours", "Expiré"

  hasDriverLicense    Boolean @default(false)
  driverLicenseNumber String?
  driverLicenseClass  String?

  // Urgence 24h
  urgency24hScore Int?    @default(0) // Score de 0 à 10
  canWorkUrgent   Boolean @default(false)

  // Vidéo d'entrevue
  videoUrl         String?
  videoUploadedAt  DateTime?
  videoStoragePath String?

  // CV et documents
  cvUrl         String?
  cvStoragePath String?
  documentsUrls String[] @default([])

  // Consentement LPRPDE
  hasConsent       Boolean   @default(false)
  consentDate      DateTime?
  consentSignature String?

  // Metadata
  isActive     Boolean   @default(true)
  isArchived   Boolean   @default(false)
  archivedAt   DateTime?
  archivedById String?
  isDeleted    Boolean   @default(false)
  deletedAt    DateTime?
  createdById  String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  createdBy           User                 @relation("CandidateCreatedBy", fields: [createdById], references: [id])
  availabilities      Availability[]
  languages           Language[]
  experiences         Experience[]
  certifications      Certification[]
  situationTests      SituationTest[]
  catalogueItems      CatalogueItem[]
  catalogueSelections CatalogueSelection[]
  placements          Placement[]
  purchases           ClientPurchase[]
  skills              CandidateSkill[] // Skills extracted from CV

  @@index([status])
  @@index([globalRating])
  @@index([city])
  @@index([hasBSP])
  @@index([hasVehicle])
  @@index([isActive])
  @@index([isArchived])
  @@index([isDeleted])
  @@index([interviewDate])
  @@index([createdAt])
  // Composite indexes for common queries (PERFORMANCE BOOST)
  @@index([isDeleted, isActive, isArchived]) // Main filtering combination
  @@index([city, status]) // City + status filtering
  @@index([status, globalRating]) // Status + rating filtering
  @@map("candidates")
}

model Availability {
  id          String           @id @default(uuid())
  candidateId String
  type        AvailabilityType
  isAvailable Boolean          @default(true)
  notes       String?

  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([candidateId])
  @@map("availabilities")
}

model Language {
  id          String        @id @default(uuid())
  candidateId String
  language    String // "Français", "Anglais", "Espagnol", etc.
  level       LanguageLevel
  canRead     Boolean       @default(true)
  canWrite    Boolean       @default(true)
  canSpeak    Boolean       @default(true)

  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([candidateId])
  @@index([language])
  @@map("languages")
}

model Experience {
  id               String    @id @default(uuid())
  candidateId      String
  companyName      String
  position         String
  startDate        DateTime?
  endDate          DateTime?
  isCurrent        Boolean   @default(false)
  durationMonths   Int? // Durée en mois
  description      String?   @db.Text
  responsibilities String?   @db.Text

  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([candidateId])
  @@map("experiences")
}

model Certification {
  id             String    @id @default(uuid())
  candidateId    String
  name           String
  issuingOrg     String?
  issueDate      DateTime?
  expiryDate     DateTime?
  certificateUrl String?

  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([candidateId])
  @@map("certifications")
}

model SituationTest {
  id             String  @id @default(uuid())
  candidateId    String
  question       String  @db.Text
  answer         String  @db.Text
  rating         Float? // Note /10 pour cette réponse
  evaluatorNotes String? @db.Text

  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([candidateId])
  @@map("situation_tests")
}

model Client {
  id          String  @id @default(uuid())
  name        String
  companyName String?
  email       String  @unique
  password    String? // Mot de passe pour login client
  phone       String?
  address     String?
  city        String?
  province    String?
  postalCode  String?

  // Billing & Pricing
  billingEmail             String?
  defaultPricePerCandidate Decimal? @db.Decimal(10, 2) // Prix par défaut par candidat
  discountPercent          Float? // Pourcentage de rabais (ex: 10 = 10%)
  paymentTerms             String? // "NET 30", "Paiement immédiat", etc.
  taxNumber                String? // Numéro de TPS/TVQ

  // Metadata
  isActive  Boolean  @default(true)
  notes     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  catalogues          Catalogue[]
  placements          Placement[]
  catalogueSelections CatalogueSelection[]
  cataloguePayments   CataloguePayment[]
  wishlists           ClientWishlist[]
  purchases           ClientPurchase[]

  @@index([email])
  @@index([companyName])
  @@map("clients")
}

model Catalogue {
  id            String          @id @default(uuid())
  clientId      String
  title         String
  customMessage String?         @db.Text
  status        CatalogueStatus @default(BROUILLON)

  // Configuration PDF
  includeSummary    Boolean @default(true)
  includeDetails    Boolean @default(true)
  includeVideo      Boolean @default(true)
  includeExperience Boolean @default(true)
  includeSituation  Boolean @default(true)
  includeCV         Boolean @default(true)

  // URLs générés
  pdfUrl         String?
  pdfStoragePath String?

  // Partage client (lien magique)
  shareToken          String?   @unique // Token unique pour accès client
  shareTokenExpiresAt DateTime? // Date d'expiration du lien

  // Gestion du paiement et visibilité
  requiresPayment  Boolean   @default(false) // Si true, détails cachés jusqu'au paiement
  isPaid           Boolean   @default(false)
  paidAt           DateTime?
  paymentAmount    Decimal?  @db.Decimal(10, 2)
  paymentReference String? // Référence de paiement/facture

  // Metadata
  generatedAt  DateTime?
  sentAt       DateTime?
  viewedAt     DateTime? // Première vue
  lastViewedAt DateTime? // Dernière vue (pour tracking multiple)
  viewCount    Int       @default(0) // Nombre de vues
  createdById  String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  client     Client               @relation(fields: [clientId], references: [id])
  createdBy  User                 @relation("CatalogueCreatedBy", fields: [createdById], references: [id])
  items      CatalogueItem[]
  selections CatalogueSelection[]
  payments   CataloguePayment[]
  purchases  ClientPurchase[]

  @@index([clientId])
  @@index([status])
  @@index([createdAt])
  @@index([shareToken])
  @@map("catalogues")
}

model CatalogueItem {
  id          String @id @default(uuid())
  catalogueId String
  candidateId String
  order       Int    @default(0)

  // Relations
  catalogue Catalogue @relation(fields: [catalogueId], references: [id], onDelete: Cascade)
  candidate Candidate @relation(fields: [candidateId], references: [id])

  @@unique([catalogueId, candidateId])
  @@index([catalogueId])
  @@index([candidateId])
  @@map("catalogue_items")
}

model Placement {
  id          String          @id @default(uuid())
  clientId    String
  candidateId String
  status      PlacementStatus @default(EN_NEGOCIATION)

  // Détails du placement
  position         String
  startDate        DateTime?
  endDate          DateTime?
  hourlyRate       Float?
  commissionRate   Float? // Taux de commission (ex: 15%)
  commissionAmount Float? // Montant commission

  // Metadata
  notes       String?  @db.Text
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  client    Client    @relation(fields: [clientId], references: [id])
  candidate Candidate @relation(fields: [candidateId], references: [id])
  createdBy User      @relation("PlacementCreatedBy", fields: [createdById], references: [id])

  @@index([clientId])
  @@index([candidateId])
  @@index([status])
  @@map("placements")
}

model AuditLog {
  id         String      @id @default(uuid())
  userId     String
  action     AuditAction
  resource   String // "Candidate", "Catalogue", "User", etc.
  resourceId String? // Generic ID - not enforced by FK
  details    String?     @db.Text
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime    @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

// Model pour les candidats potentiels (pas encore interviewés)
model ProspectCandidate {
  id String @id @default(uuid())

  // Informations personnelles
  firstName String
  lastName  String
  email     String?
  phone     String

  // Adresse
  streetAddress String?
  city          String?
  province      String? @default("QC")
  postalCode    String?
  country       String? @default("CA")
  fullAddress   String? @db.Text // Adresse complète du CSV

  // CV
  cvUrl         String? // URL du CV à télécharger
  cvStoragePath String? // Chemin local après téléchargement

  // Metadata
  timezone       String?
  submissionDate DateTime? // Date de soumission du formulaire
  isContacted    Boolean   @default(false)
  contactedAt    DateTime?
  notes          String?   @db.Text

  // Conversion
  isConverted   Boolean   @default(false) // Converti en candidat qualifié
  convertedAt   DateTime?
  convertedToId String? // ID du candidat créé après entrevue

  // Soft delete
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  purchases ClientPurchase[]

  @@index([email])
  @@index([phone])
  @@index([city])
  @@index([isContacted])
  @@index([isConverted])
  @@index([submissionDate])
  @@index([createdAt])
  @@map("prospect_candidates")
}

// Nouveau modèle pour tracker les sélections/demandes des clients
model CatalogueSelection {
  id          String                   @id @default(uuid())
  catalogueId String
  candidateId String
  clientId    String
  status      CatalogueSelectionStatus @default(INTERESSE)

  // Détails de la demande
  quantity       Int? // Nombre de postes demandés
  location       String? // Ville/lieu demandé
  startDate      DateTime? // Date de début souhaitée
  endDate        DateTime? // Date de fin souhaitée
  pricePerPerson Decimal?  @db.Decimal(10, 2) // Prix par personne
  totalAmount    Decimal?  @db.Decimal(10, 2) // Montant total
  notes          String?   @db.Text

  // Metadata
  requestedAt DateTime  @default(now())
  respondedAt DateTime? // Quand admin a répondu
  respondedBy String? // ID de l'utilisateur qui a répondu
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  catalogue Catalogue @relation(fields: [catalogueId], references: [id], onDelete: Cascade)
  candidate Candidate @relation(fields: [candidateId], references: [id])
  client    Client    @relation(fields: [clientId], references: [id])
  responder User?     @relation("SelectionResponder", fields: [respondedBy], references: [id])

  @@index([catalogueId])
  @@index([candidateId])
  @@index([clientId])
  @@index([status])
  @@index([requestedAt])
  @@map("catalogue_selections")
}

// Nouveau modèle pour tracker les paiements de catalogues
model CataloguePayment {
  id          String        @id @default(uuid())
  catalogueId String
  clientId    String
  amount      Decimal       @db.Decimal(10, 2)
  status      PaymentStatus @default(PENDING)

  // Détails du paiement
  paymentMethod    String? // "Carte de crédit", "Virement", "Chèque", etc.
  paymentReference String? // Numéro de transaction / référence
  invoiceNumber    String? // Numéro de facture
  invoiceUrl       String? // URL de la facture PDF
  paidAt           DateTime?
  dueDate          DateTime?

  // Taxes
  subtotal  Decimal? @db.Decimal(10, 2)
  taxAmount Decimal? @db.Decimal(10, 2)
  taxRate   Float? // Taux de taxe appliqué (ex: 14.975 pour QC)

  // Metadata
  notes       String?  @db.Text
  processedBy String? // ID de l'utilisateur qui a traité
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  catalogue Catalogue @relation(fields: [catalogueId], references: [id], onDelete: Cascade)
  client    Client    @relation(fields: [clientId], references: [id])
  processor User?     @relation("PaymentProcessor", fields: [processedBy], references: [id])

  @@index([catalogueId])
  @@index([clientId])
  @@index([status])
  @@index([paidAt])
  @@index([invoiceNumber])
  @@map("catalogue_payments")
}

// Pricing par ville/région
model CityPricing {
  id       String @id @default(uuid())
  city     String @unique
  province String @default("QC")

  // Prix pour candidats évalués
  evaluatedCandidateMinPrice Decimal @default(15) @db.Decimal(10, 2)
  evaluatedCandidateMaxPrice Decimal @default(45) @db.Decimal(10, 2)
  evaluatedCandidatePrice    Decimal @default(30) @db.Decimal(10, 2) // Prix moyen par défaut

  // Prix pour CVs seulement
  cvOnlyMinPrice Decimal @default(5) @db.Decimal(10, 2)
  cvOnlyMaxPrice Decimal @default(10) @db.Decimal(10, 2)
  cvOnlyPrice    Decimal @default(7.50) @db.Decimal(10, 2) // Prix moyen par défaut

  // Multiplicateur de prix (pour villes plus chères/éloignées)
  priceMultiplier Decimal @default(1.0) @db.Decimal(5, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([city])
  @@index([province])
  @@map("city_pricing")
}

// Panier/Wishlist du client
model ClientWishlist {
  id       String         @id @default(uuid())
  clientId String
  client   Client         @relation(fields: [clientId], references: [id])
  status   WishlistStatus @default(DRAFT)

  totalAmount Decimal @default(0) @db.Decimal(10, 2)

  submittedAt DateTime?
  paidAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items WishlistItem[]

  @@index([clientId])
  @@index([status])
  @@map("client_wishlists")
}

// Items dans le panier (par ville + type)
model WishlistItem {
  id         String         @id @default(uuid())
  wishlistId String
  wishlist   ClientWishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)

  city     String
  province String @default("QC")

  // Type de candidat
  type CandidateType

  // Quantité demandée
  quantity Int

  // Prix unitaire au moment de l'ajout
  unitPrice Decimal @db.Decimal(10, 2)

  // Prix total pour cet item
  totalPrice Decimal @db.Decimal(10, 2)

  // Notes du client
  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([wishlistId])
  @@index([city])
  @@map("wishlist_items")
}

// Historique des achats (pour éviter les doublons)
model ClientPurchase {
  id       String        @id @default(uuid())
  clientId String
  client   Client        @relation(fields: [clientId], references: [id])
  type     CandidateType

  candidateId String?
  candidate   Candidate? @relation(fields: [candidateId], references: [id])

  prospectId String?
  prospect   ProspectCandidate? @relation(fields: [prospectId], references: [id])

  city  String
  price Decimal @db.Decimal(10, 2)

  catalogueId String?
  catalogue   Catalogue? @relation(fields: [catalogueId], references: [id])

  purchasedAt DateTime @default(now())

  @@unique([clientId, candidateId])
  @@unique([clientId, prospectId])
  @@index([clientId])
  @@index([candidateId])
  @@index([prospectId])
  @@index([city])
  @@index([purchasedAt])
  @@map("client_purchases")
}

// Skills Extraction System

// Master database of all skills
model Skill {
  id                String        @id @default(uuid())
  name              String        @unique // Nom de la compétence (ex: "BSP", "Service à la clientèle")
  category          SkillCategory
  description       String?       @db.Text // Description détaillée
  keywords          String[] // Mots-clés pour extraction (ex: ["bsp", "bureau de la sécurité privée"])
  isActive          Boolean       @default(true) // Permet de désactiver des compétences obsolètes
  isSecurityRelated Boolean       @default(false) // Compétence liée aux agents de sécurité (core business)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  candidateSkills CandidateSkill[]

  @@index([category])
  @@index([name])
  @@index([isActive])
  @@index([isSecurityRelated])
  @@map("skills")
}

// Many-to-many relationship between Candidate and Skill
model CandidateSkill {
  id          String      @id @default(uuid())
  candidateId String
  skillId     String
  level       SkillLevel  @default(UNKNOWN)
  source      SkillSource @default(MANUAL_ENTRY)

  // Contexte d'extraction
  yearsExperience Int? // Nombre d'années d'expérience (si détecté)
  extractedText   String? @db.Text // Texte exact extrait du CV
  confidence      Float? // Score de confiance de l'IA (0-1)

  // Validation humaine
  isVerified   Boolean   @default(false)
  verifiedBy   String? // ID de l'utilisateur qui a vérifié
  verifiedAt   DateTime?
  rejectionNote String?   @db.Text // Note si la compétence est rejetée

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  skill     Skill     @relation(fields: [skillId], references: [id])

  @@unique([candidateId, skillId]) // Un candidat ne peut avoir la même compétence qu'une fois
  @@index([candidateId])
  @@index([skillId])
  @@index([level])
  @@index([source])
  @@index([isVerified])
  @@map("candidate_skills")
}

// Audit trail for CV extraction
model CvExtractionLog {
  id          String @id @default(uuid())
  candidateId String

  // Extraction details
  extractionMethod String // "REGEX", "OPENAI", "CLAUDE"
  skillsFound      Int    @default(0)
  processingTimeMs Int? // Temps de traitement en ms

  // AI details (if applicable)
  aiModel         String? // "gpt-4", "claude-3-opus", etc.
  promptTokens    Int? // Tokens utilisés dans le prompt
  completionTokens Int? // Tokens utilisés dans la réponse
  totalCost       Float? // Coût estimé en USD

  // Results
  success      Boolean @default(true)
  errorMessage String? @db.Text
  rawResponse  String? @db.Text // Réponse brute de l'IA (pour debugging)

  createdAt DateTime @default(now())

  @@index([candidateId])
  @@index([extractionMethod])
  @@index([success])
  @@index([createdAt])
  @@map("cv_extraction_logs")
}
